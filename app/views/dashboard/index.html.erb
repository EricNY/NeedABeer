
<div class="tabbable span4">
  <div id="content">
      <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
          <li class="active"><a href="#browse" data-toggle="tab" id="browse_tab"><b>Browse</b></a></li>
          <li><a href="#hist" data-toggle="tab" id="history_tab"><b>History</b></a></li>
          <li><a href="#wish" data-toggle="tab" id="wish_tab"><b>Wishlist</b></a></li>

      </ul>
      <div id="my-tab-content" class="tab-content">
          <div class="tab-pane active" id="browse">
            <form class="brewery-search">
              <input type="text" class="input-medium search-query" id='brewery'>
              <button type="submit" class="btn">Search</button>
              <p><b>Find brewery by name..</b></p>
            </form>
            <ul id='breweries'></ul>
          </div>
          <div class="tab-pane" id="hist">
              <p>I've been here!</p>
              <ul id='history-list'></ul>
          </div>
          <div class="tab-pane" id="wish">
              <p>We still have to check these places out!</p>
              <ul id='wish-list'></ul>
          </div>
      </div>
  </div> <!-- content -->
</div> <!-- tabbable -->


<div id="map-canvas" class="span7"></div>

<script id="li-template" type="text/x-handlebars-template">
  <li><b>{{brewery}}</b></li>
  <button id="history-button" onClick="historyClick()">Add to History</button>
  <button id="wish-button" onClick="wishClick()">Add to Wishlist</button>
</script>

<script>
function initialize() {
  var mapOptions = {
    zoom: 2,
    center: new google.maps.LatLng(20, 0),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
}

function loadScript() {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&' +
      'callback=initialize';
  document.body.appendChild(script);
}

function listenMarker(marker, infowindow){
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map, marker);
  });
}

var breweryId = '';
var markers = [];
// *******  wire up tabs  ***********

// history tab will clear map and only put pins of where user has been
$('#history_tab').on('click', function(){
  $('#history-list').empty();
  $.get('/histories/user/<%= current_user.id %>', function(data){
      for(var i = 0; i<data.length; i++){
        $.get('brewery_by_id', {ids: data[i].brewery_id, withLocations: 'Y'}, function(data){
          console.log(data);



          $('#history-list').append('<li>'+data[0].name+'</li>');
          var coordinates = new google.maps.LatLng(data[0].locations[0].latitude, data[0].locations[0].longitude);
          var infowindow = new google.maps.InfoWindow({content: data[0].name+'<br>'+data[0].locations[0].street_address+'<br>'+data[0].locations[0].phone+'<br>'+data[0].locations[0].website });
          var marker = new google.maps.Marker({position: coordinates, map: map});
          listenMarker(marker, infowindow)
          marker.setMap(map);
          map.setZoom(8);
          map.setCenter(coordinates);



        });
      }
  });
});

$('#wish_tab').on('click', function(){
  $('#wish-list').empty();
  $.get('/favorites/user/<%= current_user.id %>', function(data){
      //list each brewery in a ul
      for(var i = 0; i<data.length; i++){
        $.get('brewery_by_id', {ids: data[i].brewery_id, withLocations: 'Y'}, function(data){
          $('#wish-list').append('<li>'+data[0].name+'</li>');
          var coordinates = new google.maps.LatLng(data[0].locations[0].latitude, data[0].locations[0].longitude);
          var infowindow = new google.maps.InfoWindow({content: data[0].name+'<br>'+data[0].locations[0].street_address+'<br>'+data[0].locations[0].phone+'<br>'+data[0].locations[0].website });
          var marker = new google.maps.Marker({position: coordinates, map: map});
          listenMarker(marker, infowindow)
          marker.setMap(map);
          map.setZoom(8);
          map.setCenter(coordinates);
        });
      }
  });
});
// ******* End Wire Up Tabs ************

// On submit. find brewery, display it as list item get its coordinates, map pin
$('.brewery-search').on('submit', function(e){
  e.preventDefault();
  var brewery = document.getElementById('brewery').value;
  var template = Handlebars.compile( $('#li-template').html() );

  $.get('/search_by_id', {name: brewery, withLocations: 'Y'}, function(data){
    var temp = { brewery: data[0].name}
    $('#breweries').append(template(temp));
    breweryId = data[0].id;
    var coordinates = new google.maps.LatLng(data[0].locations[0].latitude, data[0].locations[0].longitude);
    var infowindow = new google.maps.InfoWindow({content: data[0].name+'<br>'+data[0].locations[0].street_address+'<br>'+data[0].locations[0].phone+'<br>'+data[0].locations[0].website });
    var marker = new google.maps.Marker({position: coordinates, map: map});
    listenMarker(marker, infowindow)
    marker.setMap(map);
    map.setZoom(8);
    map.setCenter(coordinates);
  }, 'json');

});// ----> end submit handler


// Wishlist handler
function wishClick(){
  // $.post( url [, data ] [, success(data, textStatus, jqXHR) ] [, dataType ] )
  $.post('/favorites', {brewery_id: breweryId, user_id: <%= current_user.id %>}, function(data){
    // $('#breweries').detach();
  }, 'json');
}
// -----> end Wishlist handler


// History handler
function historyClick(){
  // $.post( url [, data ] [, success(data, textStatus, jqXHR) ] [, dataType ] )
  $.post('/histories', {brewery_id: breweryId, userID: <%= current_user.id %>}, function(data){
    console.log(data);
    // $('#breweries').detach();
  }, 'json');
}
// -----> end History handler

$(document).ready(function() {
  loadScript();
  $('#tabs').tab();
});

</script>


















